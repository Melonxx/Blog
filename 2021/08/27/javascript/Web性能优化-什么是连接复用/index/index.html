<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><title>Web性能优化-什么是连接复用 | zch233</title><link rel="stylesheet" type="text/css" href="/Blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/Blog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/Blog/favicon.ico"><link rel="apple-touch-icon" href="/Blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/Blog/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Web性能优化-什么是连接复用</h1><a id="logo" href="/Blog/.">zch233</a><p class="description">人到中年</p></div><div id="nav-menu"><a class="current" href="/Blog/."><i class="fa fa-home"> Home</i></a><a href="/Blog/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Web性能优化-什么是连接复用</h1><div class="post-meta">2021-08-27<span> | </span><span class="category"><a href="/Blog/categories/javascript/">javascript</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">1.</span> <span class="toc-text">Web 性能指标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#web-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%88%B0%E5%BA%95%E5%9C%A8%E4%BC%98%E5%8C%96%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.0.1.</span> <span class="toc-text">web 性能优化到底在优化什么？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS-prefetch"><span class="toc-number">2.</span> <span class="toc-text">DNS prefetch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS-%E9%A2%84%E8%A7%A3%E6%9E%90"><span class="toc-number">2.0.1.</span> <span class="toc-text">DNS 预解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%EF%BC%88%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95%EF%BC%89"><span class="toc-number">2.0.2.</span> <span class="toc-text">优化（两种方法）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">前端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">后端</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">TCP 连接复用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.1.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E6%80%8E%E4%B9%88%E5%8A%A0-keep-alive%EF%BC%9F"><span class="toc-number">3.1.0.1.</span> <span class="toc-text">前端怎么加 keep-alive？</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.</span> <span class="toc-text">并行化连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-%E7%AE%A1%E9%81%93%E5%8C%96"><span class="toc-number">5.</span> <span class="toc-text">HTTP 管道化</span></a></li></ol></div></div><div class="post-content"><h2 id="Web-性能指标"><a href="#Web-性能指标" class="headerlink" title="Web 性能指标"></a>Web 性能指标</h2><h4 id="web-性能优化到底在优化什么？"><a href="#web-性能优化到底在优化什么？" class="headerlink" title="web 性能优化到底在优化什么？"></a>web 性能优化到底在优化什么？</h4><blockquote>
<p>你可能会说优化的是用户体验，但用户体验是不可测量的，我们必须把用户体验变成可测量的指标，这些指标包括：</p>
</blockquote>
<ol>
<li>用户按下回车</li>
<li>由内容出现时（一般3秒之内还没有内容出现，用户就会比较焦虑，会关掉页面）</li>
<li>DOM ready 事件发生（dom content loading ，代表 HTML 内容全部解析完，js 也基本执行完了，但并不保证图片已经全部加载和 css 样式加载完，就是 network 里面那跟蓝色的线）</li>
<li>页面可交互（JS 都执行了，并且把事件都绑定了，用户点击按钮不会出现没反应的情况）</li>
<li>onLoad 事件发生</li>
<li>动态资源加载完毕</li>
</ol>
<h2 id="DNS-prefetch"><a href="#DNS-prefetch" class="headerlink" title="DNS prefetch"></a>DNS prefetch</h2><h4 id="DNS-预解析"><a href="#DNS-预解析" class="headerlink" title="DNS 预解析"></a>DNS 预解析</h4><blockquote>
<p>假设 index.html 的部分代码为：</p>
<script src="http://a.com/1.js"></script>
<script src="http://b.com/1.js"></script>
</blockquote>
<blockquote>
<p>那么过程就是首先对 a.com 进行 dns 查询 &#x3D;&gt; 拿到 ip 地址以后 &#x3D;&gt; 下载a.js &#x3D;&gt; 对 b.com 进行 dns 查询（一定会等 a.js 下载执行完毕后才开始） &#x3D;&gt; 拿到 ip 地址以后 &#x3D;&gt; 下载b.js<br>如果 a.com 和 b.com 同时先进行 dns 预解析，那么就能节省一定的时间</p>
</blockquote>
<h4 id="优化（两种方法）"><a href="#优化（两种方法）" class="headerlink" title="优化（两种方法）"></a>优化（两种方法）</h4><h5 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h5><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;link ref<span class="operator">=</span><span class="string">&quot;des-prefetch&quot;</span> href<span class="operator">=</span><span class="string">&quot;https://a.com/&quot;</span> &gt;</span><br><span class="line">&lt;link ref<span class="operator">=</span><span class="string">&quot;des-prefetch&quot;</span> href<span class="operator">=</span><span class="string">&quot;https://b.com/&quot;</span> &gt;</span><br></pre></td></tr></table></figure>

<h5 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> index.html 的响应头里写</span><br><span class="line">Link: &lt;http:<span class="regexp">//</span>a.com /&gt;; rel=dns=prefetch</span><br></pre></td></tr></table></figure>

<h2 id="TCP-连接复用"><a href="#TCP-连接复用" class="headerlink" title="TCP 连接复用"></a>TCP 连接复用</h2><blockquote>
<p>正常流程：开启 TCP &#x3D;&gt; 请求 &#x3D;&gt; 响应 &#x3D;&gt; 关闭 &#x3D;&gt; 开启 TCP….<br>可以发现一直在重复开启关闭，为何不复用呢，开启后就不关闭了，节约多次重复开启关闭的时间。</p>
</blockquote>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求头</span></span><br><span class="line"><span class="symbol">Connection:</span> <span class="meta">keep</span>-alive</span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应头</span></span><br><span class="line"><span class="symbol">Connection:</span> <span class="meta">keep</span>-alive</span><br></pre></td></tr></table></figure>

<blockquote>
<p>但是如果服务器一直开着将会非常占用资源，用户一多，服务器就顶不住了，所以一般都会在设置一个超时时间，如果超过多少秒还没有再次发起连接，那么将会强制关闭。</p>
</blockquote>
 <figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求头</span></span><br><span class="line">KeepAlive: timeout=<span class="number">5</span>, <span class="built_in">max</span>=<span class="number">10</span></span><br></pre></td></tr></table></figure>
 <figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应头</span></span><br><span class="line">KeepAlive: timeout=<span class="number">10</span>, <span class="built_in">max</span>=<span class="number">100</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>客户端和服务器都可以设置这个字段，两者可以不一样，timeout 表示多少秒，max 表示多少次，一般来说聪明的浏览器会以服务器为准（尊重服务器的能力），而傻一点的浏览器（如：IE）就坚持自己为准</p>
</blockquote>
<h5 id="前端怎么加-keep-alive？"><a href="#前端怎么加-keep-alive？" class="headerlink" title="前端怎么加 keep-alive？"></a>前端怎么加 keep-alive？</h5><blockquote>
<p>如果用的 http&#x2F;1.1 以上，会自动加。<br>也就是基本上不用去优化了。</p>
</blockquote>
<h2 id="并行化连接"><a href="#并行化连接" class="headerlink" title="并行化连接"></a>并行化连接</h2><blockquote>
<p>因为连接复用是串行的，当同时处理多个请求的时候还是太慢，所以需要并行连接。<br>也就是说同时建立好几个请求（一般浏览器会设置最大数量，同一个域名一般 4-12 个）<br><strong>那么连接复用就没有用了吗？</strong><br>答案是<strong>不会</strong>，因为浏览器设置了连接上限，如果超出的连接数，那么剩下的就会等待上一个请求结束后再进行复用。</p>
</blockquote>
<p>🌰：</p>
<p><img src="/Blog/2021/08/27/javascript/Web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8/index/img.png"></p>
<blockquote>
<p>相同的 id 代表连接复用</p>
</blockquote>
<h2 id="HTTP-管道化"><a href="#HTTP-管道化" class="headerlink" title="HTTP 管道化"></a>HTTP 管道化</h2><blockquote>
<p>浏览器默认关闭，可能会有 BUG</p>
</blockquote>
<p>🌰：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">一个 http 管道-------------------------</span></span><br><span class="line"><span class="string"></span>||<span class="string"> 1.css ----- 响应</span></span><br><span class="line"><span class="string"></span>|<span class="string"> </span>|<span class="string"> 2.css ----- 响应</span></span><br><span class="line"><span class="string"></span>|<span class="string">  </span>|<span class="string"> 3.css ----- 响应</span></span><br><span class="line"><span class="string"></span>|<span class="string">--------------------------------------</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当在管道中发起（接近同时）三个请求时，会有如下问题：</p>
<ol>
<li>浏览器必须要按照相当的顺序返回响应，否则会对应不上，不像并行一样，每次都是新的连接一一对应。</li>
<li>如果 1.css 因为网络波动特别慢，那么 剩下的必须得等 1.css 响应结束才可以继续，因为一旦 2.css 提前响应了就会被浏览器错误的当成 1.css 的响应。<br>所以他会导致请求之前的顺序依赖，导致这样的并行没法导致最快的速度，所以一开始的 http 设计并不能满足现在的需求，所以需要升级为 HTTP&#x2F;2.0</li>
</ol>
</blockquote>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/Blog/2021/09/08/javascript/Web%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E7%BC%93%E5%AD%98%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86/index/">Web性能优化-缓存与内容协商</a><a class="next" href="/Blog/2021/08/24/javascript/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E5%85%B7%E7%AF%87/index/">浏览器工具篇</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: 'e4a44394ea630529848c',
  clientSecret: '884b4deb2d55fbcc63921e12f73b58e944efa110',
  repo: 'Blog',
  owner: 'zch233',
  admin: ['zch233'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="./about/" title="About"><img class="nofancybox" src="/Blog/img/avatar.png"/></a><p>coder.</p><a class="info-icon" href="zch2333333@gmail.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/zch233" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/Lisp/">Lisp</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/Rails/">Rails</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/React/">React</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/SCSS/">SCSS</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/TypeScript/">TypeScript</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/chrome%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/">chrome调试技巧</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/daisy/">daisy</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/relearnFE/">relearnFE</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E5%87%86%E5%A4%87%E9%9D%A2%E8%AF%95/">准备面试</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E6%97%A5%E5%B8%B8%E6%9D%82%E7%96%91/">日常杂疑</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E8%B6%A3%E9%97%BB/">趣闻</a></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E9%9A%8F%E7%AC%94/">随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/17/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9AJS-TS/index/">TypeScript全解：JS&TS</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/16/typescript/React%20%E6%B3%9B%E5%9E%8B%E7%BB%84%E4%BB%B6%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/index/">React 泛型组件是什么？</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/15/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9A%E7%B1%BB%E5%9E%8B%E4%BD%93%E6%93%8D%EF%BC%88%E4%B8%8A%EF%BC%89/index/">TypeScript全解：类型体操（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/15/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9A%E7%B1%BB%E5%9E%8B%E4%BD%93%E6%93%8D%EF%BC%88%E4%B8%8B%EF%BC%89/index/">TypeScript全解：类型体操（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/14/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9Aclass%EF%BC%88%E4%B8%8B%EF%BC%89/index/">TypeScript全解：class（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/14/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9Aclass%EF%BC%88%E4%B8%8A%EF%BC%89/index/">TypeScript全解：class（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/12/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9A%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8B%EF%BC%89/index/">TypeScript全解：泛型编程（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/12/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9A%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89/index/">TypeScript全解：泛型编程（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/11/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9A%E6%B7%B1%E5%85%A5%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%87%BD%E6%95%B0%EF%BC%88%E4%B8%8B%EF%BC%89/index/">TypeScript全解：深入对象与函数（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/06/11/typescript/TypeScript%E5%85%A8%E8%A7%A3%EF%BC%9A%E6%B7%B1%E5%85%A5%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%87%BD%E6%95%B0%EF%BC%88%E4%B8%8A%EF%BC%89/index/">TypeScript全解：深入对象与函数（上）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://www.jianshu.com/u/4b4c7aec223d" title="littleyu" target="_blank">littleyu</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/Blog/." rel="nofollow">zch233.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/Blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/Blog/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/Blog/css/search.css?v=1.0.0"><script type="text/javascript" src="/Blog/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/Blog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/Blog/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/Blog/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/Blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/Blog/js/smartresize.js?v=1.0.0"></script></div></body></html>